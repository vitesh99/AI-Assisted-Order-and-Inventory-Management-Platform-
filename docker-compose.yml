version: '3.8'

services:
  db:
    image: postgres:15-alpine
    container_name: ai_inventory_db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: ai_inventory_db
    volumes:
      - postgres_data_v3:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d ai_inventory_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_net

  auth-service:
    build: ./auth-service
    container_name: auth_service
    environment:
      - DATABASE_URL=postgresql+asyncpg://user:password@db/ai_inventory_db
      - SECRET_KEY=${SECRET_KEY:-supersecretkey123}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app_net

  inventory-service:
    build: ./inventory-service
    container_name: inventory_service
    environment:
      - DATABASE_URL=postgresql+asyncpg://user:password@db/ai_inventory_db
      - SECRET_KEY=${SECRET_KEY:-supersecretkey123}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app_net

  order-service:
    build: ./order-service
    container_name: order_service
    environment:
      - DATABASE_URL=postgresql+asyncpg://user:password@db/ai_inventory_db
      - SECRET_KEY=${SECRET_KEY:-supersecretkey123}
      - INVENTORY_SERVICE_URL=http://inventory-service:8000/api/v1/inventory
      - AUTH_SERVICE_URL=http://auth-service:8000/api/v1/auth
    depends_on:
      db:
        condition: service_healthy
      inventory-service:
        condition: service_started
    networks:
      - app_net

  analytics-service:
    build: ./analytics-service
    container_name: analytics_service
    environment:
      - DATABASE_URL=postgresql+asyncpg://user:password@db/ai_inventory_db
      - SECRET_KEY=${SECRET_KEY:-supersecretkey123}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app_net

  ai-service:
    build: ./ai-service
    container_name: ai_service
    environment:
      - AI_API_KEY=${AI_API_KEY}
      - AI_MODEL=${AI_MODEL}
    networks:
      - app_net

  gateway-service:
    build: ./gateway-service
    container_name: gateway_service
    ports:
      - "8000:8000"
    environment:
      - AUTH_SERVICE=http://auth-service:8000
      - INVENTORY_SERVICE=http://inventory-service:8000
      - ORDER_SERVICE=http://order-service:8000
      - ANALYTICS_SERVICE=http://analytics-service:8000
      - AI_SERVICE=http://ai-service:8000
    depends_on:
      - auth-service
      - inventory-service
      - order-service
      - analytics-service
      - ai-service
    networks:
      - app_net

  frontend:
    build: ./frontend
    container_name: frontend_service
    ports:
      - "3000:80"
    depends_on:
      - gateway-service
    networks:
      - app_net

volumes:
  postgres_data_v3:

networks:
  app_net:
    driver: bridge
